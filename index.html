<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Price Tag Printer</title>
    <link rel="icon" type="image/svg+xml" href="https://cdn.jsdelivr.net/npm/lucide-static@0.344.0/icons/tag.svg" />
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons (Vanilla JS version for definitions) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Export Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;700&family=Oswald:wght@500;700&family=Playfair+Display:wght@700;900&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              serif: ['Roboto Slab', 'serif'],
              oswald: ['Oswald', 'sans-serif'],
              playfair: ['Playfair Display', 'serif'],
              lato: ['Lato', 'sans-serif'],
            },
            screens: {
              'print': {'raw': 'print'},
            }
          }
        }
      }
    </script>
    <style>
      body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      
      /* Modern Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      @media print {
        @page {
          size: auto;
          margin: 0;
        }
        body {
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }
        .no-print {
          display: none !important;
        }
        .print-visible {
          display: block !important;
        }
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react-dom": "https://aistudiocdn.com/react-dom@^19.2.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0",
    "vite": "https://aistudiocdn.com/vite@^7.2.4",
    "@vitejs/plugin-react": "https://aistudiocdn.com/@vitejs/plugin-react@^5.1.1"
  }
}
</script>
</head>
  <body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <!-- MAIN APPLICATION SCRIPT -->
    <script type="text/babel" data-presets="react,typescript">
      const { useState, useEffect, useCallback, useMemo, useRef } = React;
      const { createPortal } = ReactDOM;

      // --- 1. ICONS COMPATIBILITY LAYER ---
      const IconWrapper = ({ name, size = 24, color = "currentColor", strokeWidth = 2, className, ...props }) => {
        const iconDef = lucide.icons[name] || lucide.icons[name.charAt(0).toLowerCase() + name.slice(1)];
        if (!iconDef) {
          console.warn(`Icon "${name}" not found`);
          return null;
        }
        return (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width={size}
            height={size}
            viewBox="0 0 24 24"
            fill="none"
            stroke={color}
            strokeWidth={strokeWidth}
            strokeLinecap="round"
            strokeLinejoin="round"
            className={className}
            {...props}
          >
            {iconDef.map(([tag, attrs], index) => 
               React.createElement(tag, { ...attrs, key: index })
            )}
          </svg>
        );
      };

      const LucideReact = new Proxy({}, {
        get: (target, prop) => {
          return (props) => <IconWrapper name={prop} {...props} />;
        }
      });
      
      const { 
        Minus, Plus, X, RotateCw, Columns, Rows, ArrowLeftRight, ArrowUpDown, Maximize2,
        Upload, Trash2, Download, Box, Tag, RotateCcw,
        Printer, Settings, LayoutGrid, Type, List, RefreshCw, Undo, Redo, Sparkles, PackageOpen,
        Check, Palette, LayoutTemplate, Smartphone, Monitor, Sliders,
        FileText, Image, File, Loader2, Save
      } = LucideReact;

      // --- 2. TYPES ---
      const TagSize = { SMALL: 'small', MEDIUM: 'medium', LARGE: 'large' };

      // --- 3. CONSTANTS ---
      const SAMPLE_DATA = `Product Name,Quantity,MRP,Offer Price
Maaza Mango Drink,1.75 Ltr,99,59
Coca Cola,2.25 Ltr,95,75
Basmati Rice (Premium),5 Kg,650,450
Sunflower Oil,1 Ltr,180,145
Good Day Cashew Cookies,200g,40,30
Maggi Noodles (Pack of 12),840g,168,140
Surf Excel Matic,2 Kg,450,380
Tata Salt,1 Kg,28,24
Red Label Tea,500g,280,240`;

      const PX_PER_CM = 37.8;

      const DEFAULT_TAG_LABELS = {
        currency: '₹',
        offLabel: 'Off',
        bestPriceLabel: 'Best Price',
        mrpLabel: 'MRP',
        priceLabel: 'Our Price'
      };

      const DEFAULT_VISUALS = {
        fontScale: 1,
        separatorStyle: 'dashed',
        separatorThickness: 2,
        sectionSpacing: 1.5,
        sectionOrder: ['savings', 'product', 'footer'],
        tagWidth: 10, 
        tagHeight: 7.5,
        paddingX: 0.5,
        paddingY: 0.5,
        textScales: {},
        layoutDirection: 'col'
      };

      const DEFAULT_CONFIG = {
        labels: DEFAULT_TAG_LABELS,
        visuals: DEFAULT_VISUALS,
        sheetSettings: { paddingX: 0.25, paddingY: 1.0, gapX: 0.05, gapY: 0.1 },
        paperOrientation: 'portrait',
        pageOrientations: {}
      };

      const FONT_THEMES = {
        classic: { label: 'Classic', nameClass: 'font-serif', priceClass: 'font-serif', metaClass: 'font-sans' },
        modern: { label: 'Modern', nameClass: 'font-oswald tracking-wide uppercase', priceClass: 'font-oswald', metaClass: 'font-opensans' },
        elegant: { label: 'Elegant', nameClass: 'font-playfair italic', priceClass: 'font-playfair', metaClass: 'font-lato' }
      };

      // --- 4. COMPONENTS ---

      // --- Ruler Component ---
      const Ruler = ({ length, orientation, padding, onPaddingChange, className }) => {
          const isHorz = orientation === 'horizontal';
          const ticks = Array.from({ length: Math.ceil(length) + 1 });
          const isDragging = useRef(false);

          const handleStartMouseDown = (e) => {
              e.preventDefault(); e.stopPropagation();
              isDragging.current = true;
              const startX = e.clientX; const startY = e.clientY; const startPadding = padding;
              const handleMouseMove = (mv) => {
                  if (!isDragging.current) return;
                  let delta = 0;
                  if (isHorz) { delta = (mv.clientX - startX) / PX_PER_CM; } 
                  else { delta = (mv.clientY - startY) / PX_PER_CM; }
                  onPaddingChange(Math.max(0, Math.min(length / 2 - 0.5, startPadding + delta)));
              };
              const handleMouseUp = () => {
                  isDragging.current = false;
                  window.removeEventListener('mousemove', handleMouseMove);
                  window.removeEventListener('mouseup', handleMouseUp);
              };
              window.addEventListener('mousemove', handleMouseMove);
              window.addEventListener('mouseup', handleMouseUp);
          };

          const handleEndMouseDown = (e) => {
              e.preventDefault(); e.stopPropagation();
              isDragging.current = true;
              const startX = e.clientX; const startY = e.clientY; const startPadding = padding;
              const handleMouseMove = (mv) => {
                  if (!isDragging.current) return;
                  let delta = 0;
                  if (isHorz) { delta = (mv.clientX - startX) / PX_PER_CM; } 
                  else { delta = (mv.clientY - startY) / PX_PER_CM; }
                  onPaddingChange(Math.max(0, Math.min(length / 2 - 0.5, startPadding - delta)));
              };
              const handleMouseUp = () => {
                  isDragging.current = false;
                  window.removeEventListener('mousemove', handleMouseMove);
                  window.removeEventListener('mouseup', handleMouseUp);
              };
              window.addEventListener('mousemove', handleMouseMove);
              window.addEventListener('mouseup', handleMouseUp);
          };

          return (
              <div className={`absolute bg-white border-slate-200 z-30 select-none print:hidden transition-opacity duration-200 opacity-90 backdrop-blur-sm ${isHorz ? 'h-6 top-0 left-0 right-0 border-b flex' : 'w-6 top-0 left-0 bottom-0 border-r block'} ${className || ''}`}>
                  {ticks.map((_, i) => (
                      <div key={i} className="absolute text-[9px] flex justify-center items-center font-sans font-medium text-slate-400"
                          style={isHorz ? { left: `${(i / length) * 100}%`, height: '100%', width: '1px', borderLeft: '1px solid #e2e8f0' } : { top: `${(i / length) * 100}%`, width: '100%', height: '1px', borderTop: '1px solid #e2e8f0' }}>
                          <span className="bg-white/90 px-0.5">{i > 0 ? i : ''}</span>
                      </div>
                  ))}
                  <div className={`absolute bg-indigo-500 hover:bg-indigo-600 transition-colors shadow-sm z-40 group`}
                      style={isHorz ? { left: `${(padding / length) * 100}%`, top: 0, bottom: 0, width: '2px', cursor: 'col-resize' } : { top: `${(padding / length) * 100}%`, left: 0, right: 0, height: '2px', cursor: 'row-resize' }}
                      onMouseDown={handleStartMouseDown} title={`Margin: ${padding.toFixed(1)}cm`}>
                      <div className={`absolute bg-indigo-500 w-2 h-2 transform rotate-45 ${isHorz ? '-left-[3px] top-0' : '-top-[3px] left-0'}`}></div>
                  </div>
                  <div className="absolute bg-slate-100/80 pointer-events-none" style={isHorz ? { left: 0, width: `${(padding / length) * 100}%`, height: '100%' } : { top: 0, height: `${(padding / length) * 100}%`, width: '100%' }} />
                  <div className={`absolute bg-indigo-500 hover:bg-indigo-600 transition-colors shadow-sm z-40 group`}
                      style={isHorz ? { right: `${(padding / length) * 100}%`, top: 0, bottom: 0, width: '2px', cursor: 'col-resize' } : { bottom: `${(padding / length) * 100}%`, left: 0, right: 0, height: '2px', cursor: 'row-resize' }}
                      onMouseDown={handleEndMouseDown} title={`Margin: ${padding.toFixed(1)}cm`}>
                      <div className={`absolute bg-indigo-500 w-2 h-2 transform rotate-45 ${isHorz ? '-right-[3px] top-0' : '-bottom-[3px] left-0'}`}></div>
                  </div>
                  <div className="absolute bg-slate-100/80 pointer-events-none" style={isHorz ? { right: 0, width: `${(padding / length) * 100}%`, height: '100%' } : { bottom: 0, height: `${(padding / length) * 100}%`, width: '100%' }} />
              </div>
          );
      };

      // --- PriceTag Component ---
      const LAYOUT_CONFIG = {
        [TagSize.SMALL]: { baseFontSize: 0.8, savings: { amount: 'text-4xl', symbol: 'text-lg', label: 'text-base -translate-y-2' }, product: { name: 'text-lg leading-tight line-clamp-2', qty: 'text-sm' }, footer: { label: 'text-xs', mrp: 'text-2xl', price: 'text-2xl' } },
        [TagSize.MEDIUM]: { baseFontSize: 1, savings: { amount: 'text-[4.5rem]', symbol: 'text-2xl', label: 'text-xl -translate-y-3' }, product: { name: 'text-2xl leading-tight line-clamp-3', qty: 'text-lg' }, footer: { label: 'text-base', mrp: 'text-4xl', price: 'text-4xl' } },
        [TagSize.LARGE]: { baseFontSize: 1.2, savings: { amount: 'text-[7rem]', symbol: 'text-3xl', label: 'text-3xl -translate-y-5' }, product: { name: 'text-3xl leading-tight line-clamp-3', qty: 'text-xl' }, footer: { label: 'text-xl', mrp: 'text-6xl', price: 'text-6xl' } }
      };

      const EditableText = ({ id, scale, onUpdateScale, children, className, value, onSave, isNumeric }) => {
        const [isOpen, setIsOpen] = useState(false);
        const [isEditing, setIsEditing] = useState(false);
        const [tempValue, setTempValue] = useState(value);
        const containerRef = useRef(null);
        const [popoverPos, setPopoverPos] = useState({ top: 0, left: 0 });

        useEffect(() => {
          if (!isOpen && !isEditing) return;
          const updatePosition = () => {
              if (containerRef.current) {
                  const rect = containerRef.current.getBoundingClientRect();
                  setPopoverPos({ top: rect.top, left: rect.left + (rect.width / 2) });
              }
          };
          updatePosition();
          window.addEventListener('scroll', updatePosition, true);
          window.addEventListener('resize', updatePosition);
          const handleClickOutside = () => setIsOpen(false);
          document.addEventListener('click', handleClickOutside); 
          return () => {
              window.removeEventListener('scroll', updatePosition, true);
              window.removeEventListener('resize', updatePosition);
              document.removeEventListener('click', handleClickOutside);
          };
        }, [isOpen, isEditing]);

        const handleContainerClick = (e) => {
          e.stopPropagation();
          if (!isOpen && !isEditing) { setIsOpen(true); }
        };

        const handleDoubleClick = (e) => {
            if (onSave && value !== undefined) {
                e.stopPropagation();
                e.preventDefault();
                setTempValue(value);
                setIsEditing(true);
                setIsOpen(false);
            }
        };

        const handleSave = () => {
             if (onSave) {
                 onSave(isNumeric ? parseFloat(tempValue) : tempValue);
             }
             setIsEditing(false);
        };

        const handleKeyDown = (e) => {
            if (e.key === 'Enter') handleSave();
            if (e.key === 'Escape') setIsEditing(false);
        };

        return (
          <div ref={containerRef} className={`relative group/text rounded cursor-pointer transition-colors hover:bg-indigo-50/50 ${className || ''}`} onClick={handleContainerClick} onDoubleClick={handleDoubleClick} title="Single click to scale, Double click to edit">
            <div className="absolute inset-0 border border-transparent group-hover/text:border-indigo-300 border-dashed rounded pointer-events-none no-print"></div>
            <div style={{ zoom: scale }} className="relative z-0">{children}</div>
            
            {/* Slider Popover - White Theme */}
            {isOpen && !isEditing && createPortal(
              <div className="fixed bg-white text-slate-700 p-2 rounded-xl shadow-xl z-[9999] flex items-center gap-2 no-print border border-slate-200 animate-in fade-in zoom-in-95 duration-200"
                style={{ top: popoverPos.top - 12, left: popoverPos.left, transform: 'translate(-50%, -100%)' }} onClick={(e) => e.stopPropagation()}>
                <button className="p-1 hover:bg-slate-100 text-slate-500 rounded-full transition-colors" onClick={() => onUpdateScale(id, Math.max(0.5, scale - 0.1))}><Minus size={14} /></button>
                <input type="range" min="0.5" max="2.5" step="0.1" value={scale} onChange={(e) => onUpdateScale(id, parseFloat(e.target.value))} className="w-20 h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-500"/>
                <button className="p-1 hover:bg-slate-100 text-slate-500 rounded-full transition-colors" onClick={() => onUpdateScale(id, Math.min(3, scale + 0.1))}><Plus size={14} /></button>
                <div className="w-px h-4 bg-slate-200 mx-1"></div>
                <button className="p-1 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors" onClick={() => setIsOpen(false)}><X size={14} /></button>
                <div className="absolute bottom-[-5px] left-1/2 -translate-x-1/2 w-2.5 h-2.5 bg-white rotate-45 border-r border-b border-slate-200"></div>
              </div>, document.body
            )}

            {/* Edit Modal */}
            {isEditing && createPortal(
                <div className="fixed inset-0 z-[10000] flex items-center justify-center bg-black/20 backdrop-blur-[1px]" onClick={() => setIsEditing(false)}>
                    <div className="bg-white p-4 rounded-xl shadow-2xl border border-slate-200 w-80 animate-in fade-in zoom-in-95 duration-200" onClick={e => e.stopPropagation()}>
                        <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Edit Text</label>
                        <input 
                            autoFocus
                            type={isNumeric ? "number" : "text"} 
                            value={tempValue} 
                            onChange={e => setTempValue(e.target.value)}
                            onKeyDown={handleKeyDown}
                            className="w-full px-3 py-2 bg-white text-slate-900 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 mb-3 outline-none"
                        />
                        <div className="flex justify-end gap-2">
                            <button onClick={() => setIsEditing(false)} className="px-3 py-1.5 text-sm text-slate-600 hover:bg-slate-100 rounded-lg">Cancel</button>
                            <button onClick={handleSave} className="px-3 py-1.5 text-sm bg-indigo-600 text-white hover:bg-indigo-700 rounded-lg font-medium">Save</button>
                        </div>
                    </div>
                </div>,
                document.body
            )}
          </div>
        );
      };

      const PriceTag = ({ product, size, fontTheme, config, enableDnD = false, onOrderChange, onVisualChange, onProductChange, onLabelChange }) => {
        const labels = config.labels;
        const productCustoms = product.customVisuals || {};
        const [previewVisuals, setPreviewVisuals] = useState(null);
        const visuals = useMemo(() => { const base = { ...config.visuals, ...productCustoms }; return previewVisuals ? { ...base, ...previewVisuals } : base; }, [config.visuals, productCustoms, previewVisuals]);
        const textScales = visuals.textScales || {};
        const layoutDirection = visuals.layoutDirection || 'col';
        const isRowLayout = layoutDirection === 'row';
        const savings = product.mrp - product.price;
        const hasSavings = savings > 0;
        const theme = FONT_THEMES[fontTheme];
        const layout = LAYOUT_CONFIG[size];
        
        const [draggedSection, setDraggedSection] = useState(null);
        const [justDroppedSection, setJustDroppedSection] = useState(null);
        const [isResizing, setIsResizing] = useState(null);
        const [isSnapped, setIsSnapped] = useState(false);
        const resizeStartRef = useRef(null);
        const snapLocks = useRef({ w: { active: false, anchor: null, timer: null, ignoreAnchor: null }, h: { active: false, anchor: null, timer: null, ignoreAnchor: null } });

        const sectionOrder = visuals.sectionOrder || ['savings', 'product', 'footer'];
        const separatorStyle = isRowLayout ? { borderRightWidth: `${visuals.separatorThickness}px`, borderRightStyle: visuals.separatorStyle, borderColor: '#1e293b', marginRight: `${visuals.sectionSpacing * 0.25}rem`, paddingRight: `${visuals.sectionSpacing * 0.25}rem` } : { borderBottomWidth: `${visuals.separatorThickness}px`, borderBottomStyle: visuals.separatorStyle, borderColor: '#1e293b', marginBottom: `${visuals.sectionSpacing * 0.25}rem`, paddingBottom: `${visuals.sectionSpacing * 0.25}rem` };
        const contentStyle = { zoom: visuals.fontScale };
        const currentWidth = visuals.tagWidth || 10;
        const currentHeight = visuals.tagHeight || 7.5;
        const currentPaddingX = visuals.paddingX || 0.5;
        const currentPaddingY = visuals.paddingY || 0.5;
        const dimensionStyle = { width: `${currentWidth}cm`, height: `${currentHeight}cm`, paddingLeft: `${currentPaddingX}cm`, paddingRight: `${currentPaddingX}cm`, paddingTop: `${currentPaddingY}cm`, paddingBottom: `${currentPaddingY}cm` };

        const handleTextScaleUpdate = (id, newScale) => { if (onVisualChange) { onVisualChange({ textScales: { ...textScales, [id]: newScale } }); } };
        const handleSwapDimensions = (e) => { e.stopPropagation(); if (!onVisualChange) return; onVisualChange({ tagWidth: currentHeight, tagHeight: currentWidth }); };
        const handleToggleLayout = (e) => { e.stopPropagation(); if (!onVisualChange) return; onVisualChange({ layoutDirection: isRowLayout ? 'col' : 'row' }); };
        const handleDragStart = (e, section) => { if (!enableDnD) return; setDraggedSection(section); e.dataTransfer.effectAllowed = 'move'; e.currentTarget.classList.add('opacity-50'); setJustDroppedSection(null); };
        const handleDragEnd = (e) => { e.currentTarget.classList.remove('opacity-50'); if (draggedSection) { setJustDroppedSection(draggedSection); setTimeout(() => setJustDroppedSection(null), 800); } setDraggedSection(null); };
        const handleDragOver = (e, targetSection) => { e.preventDefault(); if (!enableDnD || !onOrderChange || !draggedSection || draggedSection === targetSection) return; const newOrder = [...sectionOrder]; const sourceIndex = newOrder.indexOf(draggedSection); const targetIndex = newOrder.indexOf(targetSection); if (sourceIndex !== -1 && targetIndex !== -1) { newOrder.splice(sourceIndex, 1); newOrder.splice(targetIndex, 0, draggedSection); onOrderChange(newOrder); } };
        const startResize = (e, direction) => { if (!onVisualChange) return; e.preventDefault(); e.stopPropagation(); setIsResizing(direction); resizeStartRef.current = { x: e.clientX, y: e.clientY, w: currentWidth, h: currentHeight, fontScale: visuals.fontScale || 1 }; };

        const applySnap = (rawValue, axis) => {
          const SNAP_INCREMENT = 0.5; const SNAP_THRESHOLD = 0.4; 
          const nearestSnap = Math.round(rawValue / SNAP_INCREMENT) * SNAP_INCREMENT;
          const dist = Math.abs(rawValue - nearestSnap);
          const lock = snapLocks.current[axis];
          if (lock.active) { if (Math.abs(rawValue - lock.anchor) > 1.0) { if (lock.timer) clearTimeout(lock.timer); lock.active = false; lock.timer = null; setIsSnapped(false); return rawValue; } return lock.anchor; }
          if (dist < SNAP_THRESHOLD) { if (lock.ignoreAnchor === nearestSnap) { return rawValue; } lock.active = true; lock.anchor = nearestSnap; setIsSnapped(true); lock.timer = setTimeout(() => { lock.active = false; lock.ignoreAnchor = nearestSnap; lock.timer = null; setIsSnapped(false); }, 600); return nearestSnap; }
          if (dist >= SNAP_THRESHOLD) { lock.ignoreAnchor = null; if (lock.active) { if (lock.timer) clearTimeout(lock.timer); lock.active = false; setIsSnapped(false); } } return rawValue;
        };

        useEffect(() => {
          if (!isResizing) return;
          const handleMouseMove = (e) => {
            if (!resizeStartRef.current) return;
            const dxPx = e.clientX - resizeStartRef.current.x; const dyPx = e.clientY - resizeStartRef.current.y;
            const dxCm = dxPx / PX_PER_CM; const dyCm = dyPx / PX_PER_CM;
            const startW = resizeStartRef.current.w; const startH = resizeStartRef.current.h; const startScale = resizeStartRef.current.fontScale;
            const updates = {};
            if (isResizing === 'w') { const rawW = Math.max(3, startW + dxCm); updates.tagWidth = applySnap(rawW, 'w'); } 
            else if (isResizing === 'h') { const rawH = Math.max(3, startH + dyCm); updates.tagHeight = applySnap(rawH, 'h'); } 
            else if (isResizing === 'wh') { const newWidth = Math.max(3, startW + dxCm); const ratio = newWidth / startW; updates.tagWidth = newWidth; updates.tagHeight = Math.max(3, startH * ratio); updates.fontScale = Math.max(0.5, startScale * ratio); }
            setPreviewVisuals(updates);
          };
          const handleMouseUp = () => { if (onVisualChange && previewVisuals) { onVisualChange(previewVisuals); } setPreviewVisuals(null); setIsResizing(null); setIsSnapped(false); resizeStartRef.current = null; ['w', 'h'].forEach(axis => { const lock = snapLocks.current[axis]; if (lock.timer) clearTimeout(lock.timer); lock.active = false; lock.timer = null; lock.ignoreAnchor = null; }); };
          window.addEventListener('mousemove', handleMouseMove); window.addEventListener('mouseup', handleMouseUp);
          return () => { window.removeEventListener('mousemove', handleMouseMove); window.removeEventListener('mouseup', handleMouseUp); };
        }, [isResizing, onVisualChange, previewVisuals]);

        const renderSavings = () => ( <div className={`flex-shrink-0 flex flex-col justify-center items-center cursor-move overflow-hidden min-h-0 ${isRowLayout ? 'h-full w-auto px-2' : 'w-full'}`}> {hasSavings ? ( <div className="text-center w-full min-w-0"> <div className={`flex items-baseline justify-center ${theme.priceClass} font-black leading-none flex-wrap`}> <span className={`${layout.savings.symbol} mr-1`}>{labels.currency}</span> <EditableText id="savings" scale={textScales['savings'] || 1} onUpdateScale={handleTextScaleUpdate} value={Math.round(savings)} isNumeric onSave={(v) => onProductChange && onProductChange(product.id, {price: Math.max(0, product.mrp - Number(v))})}> <span className={`${layout.savings.amount} tracking-tighter`}>{Math.round(savings)}</span> </EditableText> <span className={`${layout.savings.label} ml-2 font-bold transform ${theme.metaClass}`}>{labels.offLabel}</span> </div> </div> ) : ( <div className="flex items-center justify-center h-full py-2"> <EditableText id="bestPrice" scale={textScales['bestPrice'] || 1} onUpdateScale={handleTextScaleUpdate} value={labels.bestPriceLabel} onSave={(v) => onLabelChange && onLabelChange('bestPriceLabel', v)}> <span className={`text-3xl font-bold ${theme.priceClass} uppercase`}>{labels.bestPriceLabel}</span> </EditableText> </div> )} </div> );
        const renderProduct = () => ( <div className={`flex-1 flex flex-col justify-center items-center text-center px-1 min-h-0 cursor-move overflow-hidden ${isRowLayout ? 'h-full' : 'w-full'}`}> <EditableText id="name" scale={textScales['name'] || 1} onUpdateScale={handleTextScaleUpdate} className="w-full" value={product.name} onSave={(v) => onProductChange && onProductChange(product.id, {name: v})}> <h2 className={`${theme.nameClass} font-bold ${layout.product.name} mb-2 tracking-wide break-words w-full`}> {product.name} </h2> </EditableText> <EditableText id="qty" scale={textScales['qty'] || 1} onUpdateScale={handleTextScaleUpdate} value={product.quantity} onSave={(v) => onProductChange && onProductChange(product.id, {quantity: v})}> <span className={`${theme.metaClass} ${layout.product.qty} text-slate-700 font-semibold bg-slate-100 rounded-full inline-block px-3 py-1 max-w-full truncate`}> {product.quantity} </span> </EditableText> </div> );
        const renderFooter = () => ( <div className={`flex-shrink-0 cursor-move overflow-hidden min-h-0 ${isRowLayout ? 'h-full w-auto px-2 flex flex-col justify-center' : 'w-full'}`}> <div className={`flex ${isRowLayout ? 'flex-col gap-2 items-center text-center' : 'justify-between items-end w-full'}`}> <div className={`${isRowLayout ? 'text-center' : 'text-center px-1'}`}> <EditableText id="labelMrp" scale={textScales['labelMrp'] || 1} onUpdateScale={handleTextScaleUpdate} value={labels.mrpLabel} onSave={(v) => onLabelChange && onLabelChange('mrpLabel', v)}> <div className={`${theme.metaClass} text-slate-900 font-bold uppercase ${layout.footer.label} mb-1`}>{labels.mrpLabel}</div> </EditableText> <EditableText id="mrp" scale={textScales['mrp'] || 1} onUpdateScale={handleTextScaleUpdate} value={product.mrp} isNumeric onSave={(v) => onProductChange && onProductChange(product.id, {mrp: v})}> <div className={`${theme.priceClass} ${layout.footer.mrp} line-through decoration-red-500 decoration-2 text-slate-400 font-black leading-none`}> {labels.currency}{product.mrp} </div> </EditableText> </div> <div className={`${isRowLayout ? 'text-center' : 'text-right px-1'}`}> <EditableText id="labelPrice" scale={textScales['labelPrice'] || 1} onUpdateScale={handleTextScaleUpdate} value={labels.priceLabel} onSave={(v) => onLabelChange && onLabelChange('priceLabel', v)}> <div className={`${theme.metaClass} text-slate-900 font-bold uppercase ${layout.footer.label} mb-1`}>{labels.priceLabel}</div> </EditableText> <EditableText id="price" scale={textScales['price'] || 1} onUpdateScale={handleTextScaleUpdate} value={product.price} isNumeric onSave={(v) => onProductChange && onProductChange(product.id, {price: v})}> <div className={`${theme.priceClass} ${layout.footer.price} font-black text-slate-900 leading-none`}> {labels.currency} {product.price} </div> </EditableText> </div> </div> </div> );
        const sectionRenderers = { 'savings': renderSavings, 'product': renderProduct, 'footer': renderFooter };

        return (
          <div className={`relative flex flex-col break-inside-avoid print:break-inside-avoid box-border group/tag select-none`} style={dimensionStyle}>
            {isResizing && ( <> <div className={`absolute top-[-1000px] bottom-[-1000px] w-px border-r ${isSnapped ? 'border-green-500 border-2' : 'border-indigo-400 border-dashed'} z-50 pointer-events-none print:hidden opacity-60`} style={{ right: `${currentPaddingX}cm` }} /> <div className={`absolute left-[-1000px] right-[-1000px] h-px border-b ${isSnapped ? 'border-green-500 border-2' : 'border-indigo-400 border-dashed'} z-50 pointer-events-none print:hidden opacity-60`} style={{ bottom: `${currentPaddingY}cm` }} /> <div className={`absolute ${isSnapped ? 'bg-green-600' : 'bg-indigo-600'} text-white text-xs px-2.5 py-1.5 rounded-full shadow-lg z-50 whitespace-nowrap font-mono print:hidden transition-all font-semibold`} style={{ bottom: `calc(${currentPaddingY}cm - 36px)`, right: `${currentPaddingX}cm` }}> {currentWidth.toFixed(1)}cm × {currentHeight.toFixed(1)}cm </div> </> )}
            <div className={`absolute inset-[0] transition-all duration-200 border-4 border-slate-900 bg-white overflow-hidden flex ${isRowLayout ? 'flex-row' : 'flex-col'}`} style={{ top: `${currentPaddingY}cm`, bottom: `${currentPaddingY}cm`, left: `${currentPaddingX}cm`, right: `${currentPaddingX}cm` }}>
              <div className={`flex h-full w-full ${isRowLayout ? 'flex-row' : 'flex-col'}`} style={contentStyle}>
                  {sectionOrder.map((section, index) => {
                  const isLast = index === sectionOrder.length - 1;
                  const renderer = sectionRenderers[section];
                  if (!renderer) return null;
                  return (
                      <div key={section} draggable={enableDnD} onDragStart={(e) => handleDragStart(e, section)} onDragEnd={handleDragEnd} onDragOver={(e) => handleDragOver(e, section)} style={isLast ? undefined : separatorStyle}
                      className={` ${section === 'product' ? 'flex-1 min-h-0 flex flex-col' : 'flex-shrink-0'} ${enableDnD ? 'transition-all duration-300' : ''} ${section === justDroppedSection ? 'border-green-500 bg-green-50 z-10' : (enableDnD ? 'border-transparent border hover:border-indigo-300 hover:bg-indigo-50/30' : '')} `} title={enableDnD ? "Drag to reorder" : ""}>
                      {renderer()} </div>
                  ); })}
              </div>
            </div>
            {enableDnD && ( <div className="absolute no-print pointer-events-none z-10" style={{ top: `calc(${currentPaddingY}cm + 8px)`, right: `calc(${currentPaddingX}cm + 8px)` }}> <span className="bg-indigo-600 text-white text-[10px] px-2 py-1 rounded-full opacity-40 uppercase font-bold tracking-wider">Drag items to reorder</span> </div> )}
            {onVisualChange && ( <> <div className="absolute z-40 no-print opacity-0 group-hover/tag:opacity-100 transition-all duration-300 flex flex-col gap-2" style={{ top: `calc(${currentPaddingY}cm)`, left: `calc(${currentPaddingX}cm - 36px)` }}> <button onClick={handleSwapDimensions} className="w-8 h-8 bg-white rounded-full shadow-lg border border-slate-100 text-slate-500 hover:text-indigo-600 hover:scale-110 flex items-center justify-center transition-all" title="Rotate Shape"> <RotateCw size={14} /> </button> <button onClick={handleToggleLayout} className="w-8 h-8 bg-white rounded-full shadow-lg border border-slate-100 text-slate-500 hover:text-indigo-600 hover:scale-110 flex items-center justify-center transition-all" title="Toggle Content Layout"> {isRowLayout ? <ArrowUpDown size={14} /> : <ArrowLeftRight size={14} />} </button> </div> <div className="absolute w-4 h-full cursor-col-resize z-20 no-print flex items-center justify-center group/handle-w" style={{ right: `calc(${currentPaddingX}cm - 8px)`, top: `${currentPaddingY}cm`, bottom: `${currentPaddingY}cm` }} onMouseDown={(e) => startResize(e, 'w')} title="Resize Width"> <div className="w-1.5 h-8 bg-indigo-200 rounded-full opacity-0 group-hover/tag:opacity-100 group-hover/handle-w:bg-indigo-500 transition-all shadow-sm"></div> </div> <div className="absolute h-4 w-full cursor-row-resize z-20 no-print flex items-center justify-center group/handle-h" style={{ bottom: `calc(${currentPaddingY}cm - 8px)`, left: `${currentPaddingX}cm`, right: `${currentPaddingX}cm` }} onMouseDown={(e) => startResize(e, 'h')} title="Resize Height"> <div className="h-1.5 w-8 bg-indigo-200 rounded-full opacity-0 group-hover/tag:opacity-100 group-hover/handle-h:bg-indigo-500 transition-all shadow-sm"></div> </div> <div className="absolute w-8 h-8 cursor-nwse-resize z-30 no-print flex items-center justify-center transition-all opacity-0 group-hover/tag:opacity-100 hover:scale-110" style={{ right: `calc(${currentPaddingX}cm - 16px)`, bottom: `calc(${currentPaddingY}cm - 16px)` }} onMouseDown={(e) => startResize(e, 'wh')} title="Resize Scale"> <div className="w-6 h-6 bg-white rounded-full shadow-lg border-2 border-indigo-500 flex items-center justify-center text-indigo-500"> <Maximize2 size={12} strokeWidth={3} /> </div> </div> </> )}
          </div>
        );
      };

      // --- InputForm Component ---
      const generateId = () => { if (typeof crypto !== 'undefined' && crypto.randomUUID) { return crypto.randomUUID(); } return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15); };
      const InputForm = ({ onAddProduct, onBulkAdd, onClear, hasItems }) => {
        const [name, setName] = useState(''); const [qty, setQty] = useState(''); const [mrp, setMrp] = useState(''); const [price, setPrice] = useState('');
        const fileInputRef = useRef(null);
        const handleSubmit = (e) => { e.preventDefault(); if (!name || !mrp || !price) return; onAddProduct({ id: generateId(), name, quantity: qty || '1 Unit', mrp: Number(mrp), price: Number(price), }); handleResetForm(); };
        const handleResetForm = () => { setName(''); setQty(''); setMrp(''); setPrice(''); };
        const parseCSV = (text) => {
          const lines = text.split('\n'); const products = []; const startIndex = lines[0].toLowerCase().includes('mrp') ? 1 : 0;
          for (let i = startIndex; i < lines.length; i++) {
            const line = lines[i].trim(); if (!line) continue; const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            if (parts.length >= 4) { products.push({ id: generateId(), name: parts[0].replace(/^"|"$/g, '').trim(), quantity: parts[1].replace(/^"|"$/g, '').trim(), mrp: parseFloat(parts[2].replace(/[^\d.]/g, '')), price: parseFloat(parts[3].replace(/[^\d.]/g, '')), }); }
          } return products;
        };
        const handleFileUpload = (e) => { const file = e.target.files?.[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { const text = event.target?.result; const products = parseCSV(text); onBulkAdd(products); }; reader.readAsText(file); if (fileInputRef.current) fileInputRef.current.value = ''; };
        const loadSample = () => { const products = parseCSV(SAMPLE_DATA); onBulkAdd(products); };

        return (
          <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 space-y-8">
            <div>
              <div className="flex justify-between items-center mb-5">
                  <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2"> <div className="bg-indigo-100 p-1.5 rounded-lg text-indigo-600"> <Tag className="w-4 h-4" /> </div> Add Item Manually </h2>
                  {(name || mrp || price) && ( <button type="button" onClick={handleResetForm} className="text-xs text-slate-400 hover:text-slate-600 flex items-center gap-1 transition-colors"> <RotateCcw size={12} /> Reset Form </button> )}
              </div>
              <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-12 gap-5 items-end">
                <div className="md:col-span-4"> <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Product Name</label> <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all placeholder:text-slate-400" placeholder="e.g. Maaza Mango" /> </div>
                <div className="md:col-span-3"> <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Qty / Size</label> <input type="text" value={qty} onChange={(e) => setQty(e.target.value)} className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all placeholder:text-slate-400" placeholder="e.g. 1.75 Ltr" /> </div>
                <div className="md:col-span-2"> <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">MRP</label> <div className="relative"> <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-serif">₹</span> <input type="number" value={mrp} onChange={(e) => setMrp(e.target.value)} className="w-full pl-8 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all placeholder:text-slate-400" placeholder="0" /> </div> </div>
                <div className="md:col-span-3"> <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 text-indigo-600">Offer Price</label> <div className="flex gap-3"> <div className="relative w-full"> <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-serif">₹</span> <input type="number" value={price} onChange={(e) => setPrice(e.target.value)} className="w-full pl-8 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all placeholder:text-slate-400" placeholder="0" /> </div> <button type="submit" className="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-xl transition-all shadow-md hover:shadow-lg active:scale-95 flex-shrink-0" title="Add Item"> <Plus className="w-5 h-5" strokeWidth={3} /> </button> </div> </div>
              </form>
            </div>
            <div className="border-t border-slate-100 pt-8">
              <h2 className="text-lg font-bold text-slate-800 mb-5 flex items-center gap-2"> <div className="bg-indigo-100 p-1.5 rounded-lg text-indigo-600"> <Box className="w-4 h-4" /> </div> Bulk Operations </h2>
              <div className="flex flex-wrap gap-4">
                <button type="button" onClick={() => fileInputRef.current?.click()} className="flex items-center px-5 py-2.5 bg-white hover:bg-slate-50 text-slate-700 rounded-xl border border-slate-200 shadow-sm transition-all hover:border-indigo-300 hover:text-indigo-600 group"> <Upload className="w-4 h-4 mr-2 group-hover:-translate-y-0.5 transition-transform" /> Upload CSV </button>
                <input type="file" accept=".csv" ref={fileInputRef} className="hidden" onChange={handleFileUpload} onClick={(e) => (e.currentTarget.value = '')} />
                <button type="button" onClick={loadSample} className="flex items-center px-5 py-2.5 bg-white hover:bg-slate-50 text-slate-700 rounded-xl border border-slate-200 shadow-sm transition-all hover:border-indigo-300 hover:text-indigo-600 group"> <Download className="w-4 h-4 mr-2 group-hover:-translate-y-0.5 transition-transform" /> Load Sample Data </button>
                <button type="button" onClick={onClear} disabled={!hasItems} className={`flex items-center px-5 py-2.5 rounded-xl border shadow-sm transition-all ml-auto ${ hasItems ? 'bg-white hover:bg-red-50 text-red-600 border-red-100 hover:border-red-300 cursor-pointer' : 'bg-slate-50 text-slate-300 border-slate-100 cursor-not-allowed' }`}> <Trash2 className="w-4 h-4 mr-2" /> Clear All </button>
              </div>
              <p className="mt-4 text-xs text-slate-400 bg-slate-50 inline-block px-3 py-1 rounded-md"> CSV Format: <code className="text-slate-600 font-mono">Product Name, Quantity, MRP, Offer Price</code> </p>
            </div>
          </div>
        );
      };

      // --- ConfigPanel Component ---
      const ConfigPanel = ({ config, onUpdate, onSave, onReset, onUndo, onRedo, canUndo, canRedo }) => {
        const [activeTab, setActiveTab] = useState('labels'); const [isDirty, setIsDirty] = useState(false);
        const handleLabelChange = (key, value) => { onUpdate({ ...config, labels: { ...config.labels, [key]: value } }); setIsDirty(true); };
        const handleVisualChange = (key, value) => { onUpdate({ ...config, visuals: { ...config.visuals, [key]: value } }); setIsDirty(true); };
        const handleSheetSettingChange = (key, value) => { onUpdate({ ...config, sheetSettings: { ...config.sheetSettings, [key]: value } }); setIsDirty(true); };
        const handleOrientationChange = (orientation) => { onUpdate({ ...config, paperOrientation: orientation }); setIsDirty(true); };
        const handleTextScaleChange = (id, value) => { const newScales = { ...(config.visuals.textScales || {}), [id]: value }; onUpdate({ ...config, visuals: { ...config.visuals, textScales: newScales } }); setIsDirty(true); };
        const handleSave = () => { onSave(); setIsDirty(false); };
        const renderTextScaleSlider = (label, id) => { const val = config.visuals.textScales?.[id] || 1; return ( <div className="space-y-2"> <div className="flex justify-between items-end"> <label className="text-xs font-semibold text-slate-600">{label}</label> <span className="text-xs text-indigo-600 font-mono bg-indigo-50 px-1.5 py-0.5 rounded">{val.toFixed(2)}x</span> </div> <input type="range" min="0.5" max="2.5" step="0.05" value={val} onChange={(e) => handleTextScaleChange(id, parseFloat(e.target.value))} className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" /> </div> ); };

        return (
          <div className="bg-white rounded-2xl shadow-sm border border-slate-200 max-w-5xl mx-auto flex flex-col md:flex-row overflow-hidden min-h-[600px]">
            <div className="w-full md:w-72 bg-slate-50 border-r border-slate-100 flex md:flex-col p-2 gap-1">
              <div className="p-4 mb-2 hidden md:block"> <h3 className="font-bold text-slate-800 text-lg">Settings</h3> <p className="text-xs text-slate-500 mt-1">Customize your tag output</p> </div>
              <button onClick={() => setActiveTab('labels')} className={`flex items-center px-4 py-3 text-sm font-medium rounded-xl transition-all ${ activeTab === 'labels' ? 'bg-white text-indigo-700 shadow-sm border border-slate-200/50' : 'text-slate-500 hover:bg-slate-100 hover:text-slate-900' }`}> <Type className={`w-4 h-4 mr-3 ${activeTab === 'labels' ? 'text-indigo-500' : 'text-slate-400'}`} /> Text Labels {activeTab === 'labels' && <div className="ml-auto w-1.5 h-1.5 rounded-full bg-indigo-500"></div>} </button>
              <button onClick={() => setActiveTab('visuals')} className={`flex items-center px-4 py-3 text-sm font-medium rounded-xl transition-all ${ activeTab === 'visuals' ? 'bg-white text-indigo-700 shadow-sm border border-slate-200/50' : 'text-slate-500 hover:bg-slate-100 hover:text-slate-900' }`}> <Palette className={`w-4 h-4 mr-3 ${activeTab === 'visuals' ? 'text-indigo-500' : 'text-slate-400'}`} /> Visual Style {activeTab === 'visuals' && <div className="ml-auto w-1.5 h-1.5 rounded-full bg-indigo-500"></div>} </button>
            </div>
            <div className="flex-1 p-8 overflow-y-auto">
              <div className="flex justify-between items-center mb-8 pb-4 border-b border-slate-100">
                  <div> <h2 className="text-2xl font-bold text-slate-800"> {activeTab === 'labels' ? 'Text Configuration' : 'Visual Settings'} </h2> <p className="text-sm text-slate-400 mt-1"> {activeTab === 'labels' ? 'Define global labels for your tags.' : 'Adjust dimensions, spacing and scaling.'} </p> </div>
                  <div className="flex gap-3">
                      <div className="flex gap-1 mr-2 border-r border-slate-100 pr-4"> <button onClick={onUndo} disabled={!canUndo} className={`p-2 rounded-lg transition-colors ${ canUndo ? 'text-slate-600 hover:bg-slate-100' : 'text-slate-300 cursor-not-allowed' }`} title="Undo"> <Undo className="w-5 h-5" /> </button> <button onClick={onRedo} disabled={!canRedo} className={`p-2 rounded-lg transition-colors ${ canRedo ? 'text-slate-600 hover:bg-slate-100' : 'text-slate-300 cursor-not-allowed' }`} title="Redo"> <Redo className="w-5 h-5" /> </button> </div>
                      <button onClick={onReset} className="flex items-center px-4 py-2 text-sm text-slate-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors font-medium" title="Reset All to Defaults"> <RotateCcw className="w-4 h-4 mr-2" /> Reset </button>
                      <button onClick={handleSave} className={`flex items-center px-6 py-2 text-sm font-bold text-white rounded-lg transition-all shadow-md ${ isDirty ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-slate-300 cursor-default' }`} title="Save Configuration"> {isDirty ? <Save className="w-4 h-4 mr-2" /> : <Check className="w-4 h-4 mr-2" />} {isDirty ? 'Save Changes' : 'Saved'} </button>
                  </div>
              </div>
              {activeTab === 'labels' && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 animate-in fade-in slide-in-from-bottom-2 duration-300">
                  <div className="space-y-2"> <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider">Currency Symbol</label> <input type="text" value={config.labels.currency} onChange={(e) => handleLabelChange('currency', e.target.value)} className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all" placeholder="₹" /> </div>
                  <div className="space-y-2"> <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider">Discount Label</label> <input type="text" value={config.labels.offLabel} onChange={(e) => handleLabelChange('offLabel', e.target.value)} className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all" placeholder="Off" /> </div>
                  <div className="space-y-2"> <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider">MRP Label</label> <input type="text" value={config.labels.mrpLabel} onChange={(e) => handleLabelChange('mrpLabel', e.target.value)} className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all" placeholder="MRP" /> </div>
                  <div className="space-y-2"> <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider">Price Label</label> <input type="text" value={config.labels.priceLabel} onChange={(e) => handleLabelChange('priceLabel', e.target.value)} className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all" placeholder="Our Price" /> </div>
                  <div className="md:col-span-2 space-y-2"> <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider">No Discount Label</label> <input type="text" value={config.labels.bestPriceLabel} onChange={(e) => handleLabelChange('bestPriceLabel', e.target.value)} className="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all" placeholder="Best Price" /> </div>
                </div>
              )}
              {activeTab === 'visuals' && (
                <div className="space-y-8 animate-in fade-in slide-in-from-bottom-2 duration-300">
                  <div className="bg-slate-50 p-6 rounded-2xl border border-slate-100">
                      <div className="mb-4"> <label className="font-bold text-slate-800 flex items-center"> <LayoutTemplate className="w-4 h-4 mr-2 text-indigo-500" /> Paper Orientation </label> <p className="text-xs text-slate-500 mt-1">Select the paper layout for printing.</p> </div>
                      <div className="flex gap-4">
                          <button onClick={() => handleOrientationChange('portrait')} className={`flex-1 p-4 rounded-xl border-2 flex flex-col items-center justify-center gap-3 transition-all ${ config.paperOrientation === 'portrait' || !config.paperOrientation ? 'border-indigo-500 bg-white shadow-md text-indigo-700' : 'border-slate-200 bg-white text-slate-500 hover:border-indigo-200' }`}> <Smartphone className="w-8 h-8 opacity-80" strokeWidth={1.5} /> <span className="font-semibold text-sm">Portrait</span> </button>
                          <button onClick={() => handleOrientationChange('landscape')} className={`flex-1 p-4 rounded-xl border-2 flex flex-col items-center justify-center gap-3 transition-all ${ config.paperOrientation === 'landscape' ? 'border-indigo-500 bg-white shadow-md text-indigo-700' : 'border-slate-200 bg-white text-slate-500 hover:border-indigo-200' }`}> <Monitor className="w-8 h-8 opacity-80" strokeWidth={1.5} /> <span className="font-semibold text-sm">Landscape</span> </button>
                      </div>
                  </div>
                  <div className="bg-slate-50 p-6 rounded-2xl border border-slate-100">
                      <div className="mb-4"> <label className="font-bold text-slate-800 flex items-center"> <LayoutGrid className="w-4 h-4 mr-2 text-indigo-500" /> Sheet Layout & Gaps </label> <p className="text-xs text-slate-500 mt-1">Adjust spacing between tags on the print sheet.</p> </div>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                          <div> <div className="flex justify-between items-center mb-2"> <label className="text-sm font-semibold text-slate-600">Horizontal Gap</label> <span className="text-xs font-mono bg-white px-2 py-1 rounded border border-slate-200 text-slate-600">{config.sheetSettings.gapX}cm</span> </div> <input type="range" min="0" max="2" step="0.1" value={config.sheetSettings.gapX} onChange={(e) => handleSheetSettingChange('gapX', parseFloat(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" /> </div>
                          <div> <div className="flex justify-between items-center mb-2"> <label className="text-sm font-semibold text-slate-600">Vertical Gap</label> <span className="text-xs font-mono bg-white px-2 py-1 rounded border border-slate-200 text-slate-600">{config.sheetSettings.gapY}cm</span> </div> <input type="range" min="0" max="2" step="0.1" value={config.sheetSettings.gapY} onChange={(e) => handleSheetSettingChange('gapY', parseFloat(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" /> </div>
                      </div>
                  </div>
                  <div className="bg-slate-50 p-6 rounded-2xl border border-slate-100"> <div className="flex justify-between items-center mb-3"> <label className="font-bold text-slate-800 flex items-center"> <LayoutTemplate className="w-4 h-4 mr-2 text-indigo-500" /> Internal Section Spacing </label> <span className="text-xs font-mono bg-white px-2 py-1 rounded border border-slate-200 text-slate-600">{config.visuals.sectionSpacing}x</span> </div> <input type="range" min="0" max="12" step="0.5" value={config.visuals.sectionSpacing} onChange={(e) => handleVisualChange('sectionSpacing', parseFloat(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" /> </div>
                  <div className="bg-slate-50 p-6 rounded-2xl border border-slate-100"> <div className="flex justify-between items-center mb-3"> <label className="font-bold text-slate-800 flex items-center"> <Type className="w-4 h-4 mr-2 text-indigo-500" /> Global Content Scale </label> <span className="text-xs font-mono bg-white px-2 py-1 rounded border border-slate-200 text-slate-600">{Math.round(config.visuals.fontScale * 100)}%</span> </div> <input type="range" min="0.7" max="1.3" step="0.05" value={config.visuals.fontScale} onChange={(e) => handleVisualChange('fontScale', parseFloat(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" /> </div>
                  <div className="bg-slate-50 p-6 rounded-2xl border border-slate-100">
                      <div className="mb-6"> <label className="font-bold text-slate-800 flex items-center"> <Sliders className="w-4 h-4 mr-2 text-indigo-500" /> Fine-Tune Element Sizes </label> <p className="text-xs text-slate-500 mt-1">Adjust specific text elements relative to the base size.</p> </div>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-6"> {renderTextScaleSlider("Product Name", "name")} {renderTextScaleSlider("Price (Our Price)", "price")} {renderTextScaleSlider("Label: Our Price", "labelPrice")} {renderTextScaleSlider("MRP (Original Price)", "mrp")} {renderTextScaleSlider("Label: MRP", "labelMrp")} {renderTextScaleSlider("Savings Amount", "savings")} {renderTextScaleSlider("Quantity / Size", "qty")} {renderTextScaleSlider("No Discount Label", "bestPrice")} </div>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div> <label className="block text-sm font-semibold text-slate-700 mb-2">Separator Line Type</label> <select value={config.visuals.separatorStyle} onChange={(e) => handleVisualChange('separatorStyle', e.target.value)} className="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none bg-white"> <option value="dashed">Dashed</option> <option value="solid">Solid</option> <option value="dotted">Dotted</option> <option value="none">None</option> </select> </div>
                      <div> <label className="block text-sm font-semibold text-slate-700 mb-2">Separator Thickness</label> <div className="flex items-center gap-4"> <input type="range" min="1" max="6" value={config.visuals.separatorThickness} onChange={(e) => handleVisualChange('separatorThickness', parseInt(e.target.value))} className="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600" /> <span className="text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-600">{config.visuals.separatorThickness}px</span> </div> </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      };

      // --- App Component ---

      const App = () => {
        const [activeTab, setActiveTab] = useState('generator');
        const [tagSize, setTagSize] = useState(TagSize.MEDIUM);
        const [fontTheme, setFontTheme] = useState('classic');
        const [showSaveToast, setShowSaveToast] = useState(false);
        const [isExporting, setIsExporting] = useState(false);

        const getInitialState = () => {
          let initialConfig = DEFAULT_CONFIG;
          try {
            const saved = localStorage.getItem('appConfig');
            if (saved) {
              const parsed = JSON.parse(saved);
              let loadedVisuals = { ...DEFAULT_CONFIG.visuals, ...(parsed.visuals || {}) };
              if (loadedVisuals.tagWidth > 50) loadedVisuals.tagWidth = DEFAULT_CONFIG.visuals.tagWidth;
              if (loadedVisuals.tagHeight > 50) loadedVisuals.tagHeight = DEFAULT_CONFIG.visuals.tagHeight;
              if (loadedVisuals.sectionOrder) { const validSections = ['savings', 'product', 'footer']; const isValid = Array.isArray(loadedVisuals.sectionOrder) && loadedVisuals.sectionOrder.every((s) => validSections.includes(s)); if (!isValid) loadedVisuals.sectionOrder = DEFAULT_CONFIG.visuals.sectionOrder; }
              initialConfig = { labels: { ...DEFAULT_CONFIG.labels, ...(parsed.labels || parsed) }, visuals: loadedVisuals, sheetSettings: { ...DEFAULT_CONFIG.sheetSettings, ...(parsed.sheetSettings || {}) }, paperOrientation: parsed.paperOrientation || 'portrait', pageOrientations: parsed.pageOrientations || {} };
            }
          } catch (e) { console.error("Failed to load config", e); }
          return { products: [], config: initialConfig };
        };

        const [history, setHistory] = useState({ past: [], present: getInitialState(), future: [] });
        const { products, config } = history.present;
        const canUndo = history.past.length > 0;
        const canRedo = history.future.length > 0;

        const updateState = useCallback((updater) => {
          setHistory(curr => {
            const nextPresent = updater(curr.present);
            if (JSON.stringify(curr.present) === JSON.stringify(nextPresent)) return curr;
            const newPast = [...curr.past, curr.present].slice(-50);
            return { past: newPast, present: nextPresent, future: [] };
          });
        }, []);

        const handleUndo = useCallback(() => { setHistory(curr => { if (curr.past.length === 0) return curr; const previous = curr.past[curr.past.length - 1]; const newPast = curr.past.slice(0, -1); return { past: newPast, present: previous, future: [curr.present, ...curr.future] }; }); }, []);
        const handleRedo = useCallback(() => { setHistory(curr => { if (curr.future.length === 0) return curr; const next = curr.future[0]; const newFuture = curr.future.slice(1); return { past: [...curr.past, curr.present], present: next, future: newFuture }; }); }, []);
        useEffect(() => { const handleKeyDown = (e) => { if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'z') { if (e.shiftKey) { e.preventDefault(); handleRedo(); } else { e.preventDefault(); handleUndo(); } } else if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'y') { e.preventDefault(); handleRedo(); } }; window.addEventListener('keydown', handleKeyDown); return () => window.removeEventListener('keydown', handleKeyDown); }, [handleUndo, handleRedo]);
        
        const handleSaveConfig = useCallback(() => { localStorage.setItem('appConfig', JSON.stringify(config)); setShowSaveToast(true); setTimeout(() => setShowSaveToast(false), 2000); }, [config]);
        const handleResetConfig = useCallback(() => { if (window.confirm('Are you sure you want to reset all configuration to default?')) { updateState(prev => ({ ...prev, config: DEFAULT_CONFIG })); } }, [updateState]);
        const handleConfigUpdate = useCallback((newConfig) => { updateState(prev => ({ ...prev, config: newConfig })); }, [updateState]);
        const handleSectionReorder = useCallback((newOrder) => { updateState(prev => ({ ...prev, config: { ...prev.config, visuals: { ...prev.config.visuals, sectionOrder: newOrder } } })); }, [updateState]);
        const handleAddProduct = useCallback((product) => { updateState(prev => ({ ...prev, products: [...prev.products, product] })); }, [updateState]);
        const handleBulkAdd = useCallback((newProducts) => { updateState(prev => ({ ...prev, products: [...prev.products, ...newProducts] })); }, [updateState]);
        const handleClear = useCallback(() => { updateState(prev => { if (prev.products.length === 0) return prev; return { ...prev, products: [] }; }); }, [updateState]);
        const handleRemoveProduct = useCallback((id) => { updateState(prev => ({ ...prev, products: prev.products.filter(p => p.id !== id) })); }, [updateState]);
        const handlePrint = () => { window.print(); };
        const handlePageOrientationToggle = (pageIndex, current) => { const newOrientation = current === 'landscape' ? 'portrait' : 'landscape'; updateState(prev => ({ ...prev, config: { ...prev.config, pageOrientations: { ...prev.config.pageOrientations, [pageIndex]: newOrientation } } })); };
        const handleSheetPaddingChange = (axis, val) => { updateState(prev => ({ ...prev, config: { ...prev.config, sheetSettings: { ...prev.config.sheetSettings, [axis === 'x' ? 'paddingX' : 'paddingY']: val } } })); };
        const handleProductVisualChange = (id, updates) => { updateState(prev => ({ ...prev, products: prev.products.map(p => { if (p.id !== id) return p; const currentVisuals = p.customVisuals || { ...prev.config.visuals }; let newVisuals = { ...currentVisuals, ...updates }; if (updates.textScales && currentVisuals.textScales) { newVisuals.textScales = { ...currentVisuals.textScales, ...updates.textScales }; } return { ...p, customVisuals: newVisuals }; }) })); };

        // --- New Handlers for Editable Text ---
        const handleProductChange = useCallback((id, updates) => {
            updateState(prev => ({
                ...prev,
                products: prev.products.map(p => p.id === id ? { ...p, ...updates } : p)
            }));
        }, [updateState]);

        const handleLabelChange = useCallback((key, value) => {
            updateState(prev => ({
                ...prev,
                config: { ...prev.config, labels: { ...prev.config.labels, [key]: value } }
            }));
        }, [updateState]);

        const paginatedResult = useMemo(() => {
          if (products.length === 0) return { pages: [], orientations: [] };
          const A4_WIDTH_CM = 21.0; const A4_HEIGHT_CM = 29.7;
          const PADDING_Y_CM = config.sheetSettings?.paddingY ?? DEFAULT_CONFIG.sheetSettings.paddingY; const PADDING_X_CM = config.sheetSettings?.paddingX ?? DEFAULT_CONFIG.sheetSettings.paddingX; const GAP_X_CM = config.sheetSettings?.gapX ?? DEFAULT_CONFIG.sheetSettings.gapX; const GAP_Y_CM = config.sheetSettings?.gapY ?? DEFAULT_CONFIG.sheetSettings.gapY;
          const defaultW = config.visuals.tagWidth || 10; const defaultH = config.visuals.tagHeight || 8;
          const resultPages = []; const resultOrientations = [];
          let globalIndex = 0; let pageIndex = 0; const MAX_PAGES = 100; 

          while (globalIndex < products.length && pageIndex < MAX_PAGES) {
              const orientation = config.pageOrientations?.[pageIndex] || config.paperOrientation || 'portrait';
              resultOrientations.push(orientation);
              const isLand = orientation === 'landscape';
              const PAGE_WIDTH = isLand ? A4_HEIGHT_CM : A4_WIDTH_CM; const PAGE_HEIGHT = isLand ? A4_WIDTH_CM : A4_HEIGHT_CM;
              const AVAILABLE_WIDTH = Math.max(1, PAGE_WIDTH - (PADDING_X_CM * 2)); const AVAILABLE_HEIGHT = Math.max(1, PAGE_HEIGHT - (PADDING_Y_CM * 2));
              const currentPageProducts = []; let currentY = 0;

              while (globalIndex < products.length) {
                  let tempIndex = globalIndex; let rowWidth = 0; let rowHeight = 0; let rowCount = 0;
                  while (tempIndex < products.length) {
                      const p = products[tempIndex]; const w = p.customVisuals?.tagWidth || defaultW; const h = p.customVisuals?.tagHeight || defaultH; const gap = rowCount > 0 ? GAP_X_CM : 0;
                      if (rowWidth + w + gap <= AVAILABLE_WIDTH) { rowWidth += w + gap; rowHeight = Math.max(rowHeight, h); rowCount++; tempIndex++; } else { break; }
                  }
                  if (rowCount === 0 && tempIndex < products.length) { const p = products[tempIndex]; rowHeight = p.customVisuals?.tagHeight || defaultH; rowCount = 1; tempIndex++; }
                  const gapY = currentPageProducts.length > 0 ? GAP_Y_CM : 0;
                  if (currentPageProducts.length > 0 && currentY + rowHeight + gapY > AVAILABLE_HEIGHT) { break; }
                  for (let i = globalIndex; i < tempIndex; i++) { currentPageProducts.push(products[i]); }
                  currentY += rowHeight + gapY; globalIndex = tempIndex;
              }
              resultPages.push(currentPageProducts); pageIndex++;
          }
          return { pages: resultPages, orientations: resultOrientations };
        }, [products, config]);

        const [draggedProductId, setDraggedProductId] = useState(null);
        const onProductDragStart = (e, id) => { setDraggedProductId(id); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', id); e.currentTarget.classList.add('opacity-40'); };
        const onProductDragEnd = (e) => { setDraggedProductId(null); e.currentTarget.classList.remove('opacity-40'); };
        const onProductDragOver = (e) => { e.preventDefault(); };
        const onProductDrop = (e, targetId) => { e.preventDefault(); const sourceId = draggedProductId; if (!sourceId || sourceId === targetId) return; updateState(prev => { const list = [...prev.products]; const indexSource = list.findIndex(p => p.id === sourceId); const indexTarget = list.findIndex(p => p.id === targetId); if (indexSource === -1 || indexTarget === -1) return prev; const [movedProduct] = list.splice(indexSource, 1); list.splice(indexTarget, 0, movedProduct); return { ...prev, products: list }; }); };

        // --- Export Functions ---

        const generatePageImages = async () => {
          const pages = document.querySelectorAll('.print-page');
          if (!pages.length) return [];
          const images = [];
          for (let i = 0; i < pages.length; i++) {
              const page = pages[i];
              // Ensure background is explicitly white for capture
              const originalBg = page.style.background;
              page.style.background = 'white';
              try {
                  const canvas = await html2canvas(page, { scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff' });
                  images.push({ dataUrl: canvas.toDataURL('image/png'), width: canvas.width, height: canvas.height, orientation: canvas.width > canvas.height ? 'landscape' : 'portrait' });
              } catch (e) { console.error("Capture failed", e); } finally { page.style.background = originalBg; }
          }
          return images;
        };

        const handleDownloadPNG = async () => {
          if (products.length === 0) return;
          setIsExporting(true);
          await new Promise(resolve => setTimeout(resolve, 100)); // UI flush
          try {
              const images = await generatePageImages();
              images.forEach((img, idx) => { const link = document.createElement('a'); link.href = img.dataUrl; link.download = `price-tags-sheet-${idx + 1}.png`; link.click(); });
          } catch (e) { alert('Failed to generate PNGs'); console.error(e); }
          setIsExporting(false);
        };

        const handleDownloadPDF = async () => {
          if (products.length === 0) return;
          setIsExporting(true);
          await new Promise(resolve => setTimeout(resolve, 100));
          try {
              const { jsPDF } = window.jspdf;
              const images = await generatePageImages();
              if (images.length === 0) throw new Error("No pages");
              const doc = new jsPDF({ orientation: images[0].orientation, unit: 'mm', format: 'a4' });
              images.forEach((img, idx) => {
                  if (idx > 0) doc.addPage(null, img.orientation);
                  const a4Width = img.orientation === 'landscape' ? 297 : 210;
                  const a4Height = img.orientation === 'landscape' ? 210 : 297;
                  doc.addImage(img.dataUrl, 'PNG', 0, 0, a4Width, a4Height);
              });
              doc.save('price-tags.pdf');
          } catch (e) { alert('Failed to generate PDF'); console.error(e); }
          setIsExporting(false);
        };

        const handleDownloadDoc = () => {
            if (products.length === 0) return;
            setIsExporting(true);
            setTimeout(() => {
                try {
                    const themeStyles = {
                        classic: { font: '"Times New Roman", serif' },
                        modern: { font: '"Arial", sans-serif' },
                        elegant: { font: '"Georgia", serif' }
                    };
                    const currentThemeFont = themeStyles[fontTheme].font;
                    let docBody = '';

                    paginatedResult.pages.forEach((pageProducts, pageIndex) => {
                        const pageBreak = pageIndex > 0 ? 'page-break-before: always;' : '';
                        docBody += `<div style="${pageBreak} width: 100%; font-family: ${currentThemeFont};">`;
                        docBody += `<div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">`; 
                        
                        pageProducts.forEach(p => {
                            const visuals = { ...config.visuals, ...(p.customVisuals || {}) };
                            const width = visuals.tagWidth || 10;
                            const height = visuals.tagHeight || 7.5;
                            const isRow = visuals.layoutDirection === 'row';
                            const borderStyle = visuals.separatorStyle === 'none' ? 'none' : `1px ${visuals.separatorStyle} #000`;
                            
                            docBody += `<div style="
                                width: ${width}cm; 
                                height: ${height}cm; 
                                border: 4px solid #000; 
                                padding: 0.5cm; 
                                margin: 0.2cm; 
                                display: inline-block; 
                                vertical-align: top;
                                box-sizing: border-box;
                                background: #fff;
                                overflow: hidden;
                            ">`;
                            docBody += `<table style="width: 100%; height: 100%; border-collapse: collapse;">`;
                            
                            const sections = visuals.sectionOrder || ['savings', 'product', 'footer'];
                            
                            // If ROW layout: one row, multiple cells. If COL layout: multiple rows, one cell each.
                            if (isRow) {
                                docBody += `<tr>`;
                            }

                            sections.forEach((section, idx) => {
                                const isLast = idx === sections.length - 1;
                                let cellStyle = `vertical-align: middle; padding: 5px;`;
                                
                                if (!isRow && !isLast && visuals.separatorStyle !== 'none') {
                                     cellStyle += `border-bottom: ${visuals.separatorThickness}px ${visuals.separatorStyle} #ccc;`;
                                } else if (isRow && !isLast && visuals.separatorStyle !== 'none') {
                                     cellStyle += `border-right: ${visuals.separatorThickness}px ${visuals.separatorStyle} #ccc;`;
                                }

                                if (!isRow) {
                                    docBody += `<tr>`;
                                }
                                docBody += `<td style="${cellStyle}">`;

                                if (section === 'savings') {
                                    const savings = p.mrp - p.price;
                                    if (savings > 0) {
                                        docBody += `<div style="text-align: center;">
                                            <span style="font-size: 14pt;">${config.labels.currency}</span>
                                            <span style="font-size: 36pt; font-weight: bold;">${Math.round(savings)}</span>
                                            <span style="font-size: 14pt;">${config.labels.offLabel}</span>
                                        </div>`;
                                    } else {
                                        docBody += `<div style="text-align: center; font-size: 24pt; font-weight: bold; text-transform: uppercase;">
                                            ${config.labels.bestPriceLabel}
                                        </div>`;
                                    }
                                } else if (section === 'product') {
                                    docBody += `<div style="text-align: center;">
                                        <div style="font-size: 18pt; font-weight: bold; margin-bottom: 5px;">${p.name}</div>
                                        <span style="background: #f1f5f9; padding: 4px 12px; border-radius: 999px; font-size: 12pt; color: #334155;">${p.quantity}</span>
                                    </div>`;
                                } else if (section === 'footer') {
                                    docBody += `<table style="width: 100%;"><tr>`;
                                    docBody += `<td style="text-align: center; width: 50%;">
                                        <div style="font-size: 10pt; text-transform: uppercase; font-weight: bold;">${config.labels.mrpLabel}</div>
                                        <div style="font-size: 20pt; text-decoration: line-through; color: #94a3b8; font-weight: bold;">
                                            ${config.labels.currency}${p.mrp}
                                        </div>
                                    </td>`;
                                    docBody += `<td style="text-align: center; width: 50%;">
                                        <div style="font-size: 10pt; text-transform: uppercase; font-weight: bold;">${config.labels.priceLabel}</div>
                                        <div style="font-size: 24pt; font-weight: 900; color: #000;">
                                            ${config.labels.currency}${p.price}
                                        </div>
                                    </td>`;
                                    docBody += `</tr></table>`;
                                }
                                docBody += `</td>`;
                                if (!isRow) {
                                    docBody += `</tr>`;
                                }
                            });
                            
                            if (isRow) {
                                docBody += `</tr>`;
                            }

                            docBody += `</table>`;
                            docBody += `</div>`; 
                        });
                        docBody += `</div></div>`;
                    });

                    const preHtml = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Price Tags</title><style>@page { mso-page-orientation: landscape; } @page Section1 { size: 8.27in 11.69in; margin: 0.5in; mso-header-margin: 0.5in; mso-footer-margin: 0.5in; mso-paper-source: 0; } div.Section1 { page:Section1; }</style></head><body><div class="Section1">`;
                    const postHtml = "</div></body></html>";
                    const html = preHtml + docBody + postHtml;
                    const blob = new Blob([html], { type: 'application/msword' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'price-tags-editable.doc';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                } catch (e) {
                    alert('Failed to generate Document');
                    console.error(e);
                }
                setIsExporting(false);
            }, 100);
        };

        return (
          <div className="min-h-screen bg-slate-50 text-slate-800 font-sans">
            <style>{`
              @media print {
                  @page { size: auto; margin: 0; }
                  @page p-portrait { size: A4 portrait; }
                  @page p-landscape { size: A4 landscape; }
                  .print-page-portrait { page: p-portrait; }
                  .print-page-landscape { page: p-landscape; }
                  .print-page {
                      break-after: page; margin: 0 !important;
                      box-shadow: none !important; border: none !important;
                      height: auto !important; min-height: 0 !important;
                      overflow: visible !important; width: auto !important;
                  }
              }
            `}</style>
            <header className="bg-slate-900 text-white shadow-md no-print sticky top-0 z-50 border-b border-slate-800">
              <div className="max-w-[1400px] mx-auto px-4 lg:px-6 py-3">
                <div className="flex flex-col xl:flex-row justify-between items-center gap-4">
                  <div className="flex items-center gap-3 w-full xl:w-auto">
                    <div className="bg-indigo-600 text-white p-2.5 rounded-xl shadow-lg shadow-indigo-900/50"> <LayoutGrid size={22} strokeWidth={2.5} /> </div>
                    <div> <h1 className="text-xl font-bold tracking-tight text-white leading-tight">SmartTag Print</h1> <p className="text-xs text-slate-400 font-medium">Retail Price Tag Generator</p> </div>
                  </div>
                  <div className="flex items-center gap-4 bg-slate-800/50 p-1.5 rounded-2xl border border-slate-700/50 backdrop-blur-md">
                      <nav className="flex bg-slate-900/80 p-1 rounded-xl">
                        <button onClick={() => setActiveTab('generator')} className={`flex items-center px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200 ${ activeTab === 'generator' ? 'bg-slate-700 text-white shadow-md' : 'text-slate-400 hover:text-white hover:bg-slate-800' }`}> <List size={16} className="mr-2" /> Generator </button>
                        <button onClick={() => setActiveTab('config')} className={`flex items-center px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-200 ${ activeTab === 'config' ? 'bg-slate-700 text-white shadow-md' : 'text-slate-400 hover:text-white hover:bg-slate-800' }`}> <Settings size={16} className="mr-2" /> Configuration </button>
                      </nav>
                      <div className="w-px h-6 bg-slate-700 mx-1"></div>
                      <div className="flex items-center gap-1">
                          <button onClick={handleUndo} disabled={!canUndo} className={`p-2 rounded-lg transition-colors ${canUndo ? 'text-slate-300 hover:text-white hover:bg-slate-700' : 'text-slate-600 cursor-not-allowed'}`} title="Undo (Ctrl+Z)"> <Undo size={18} /> </button>
                          <button onClick={handleRedo} disabled={!canRedo} className={`p-2 rounded-lg transition-colors ${canRedo ? 'text-slate-300 hover:text-white hover:bg-slate-700' : 'text-slate-600 cursor-not-allowed'}`} title="Redo (Ctrl+Y)"> <Redo size={18} /> </button>
                      </div>
                  </div>
                  {activeTab === 'generator' && (
                    <div className="flex flex-wrap justify-center items-center gap-3 w-full xl:w-auto">
                      <div className="flex items-center gap-2 bg-slate-800 rounded-xl p-1.5 border border-slate-700/50">
                          <Type size={16} className="ml-2 text-slate-500" />
                          <div className="flex gap-1">
                            {Object.keys(FONT_THEMES).map((theme) => ( <button key={theme} onClick={() => setFontTheme(theme)} className={`px-3 py-1.5 rounded-lg text-xs font-semibold transition-all ${ fontTheme === theme ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-400 hover:text-white hover:bg-slate-700' }`}> {FONT_THEMES[theme].label} </button> ))}
                          </div>
                      </div>
                      <div className="flex bg-slate-800 rounded-xl p-1.5 border border-slate-700/50">
                          <button onClick={() => setTagSize(TagSize.SMALL)} className={`px-3 py-1.5 rounded-lg text-xs font-semibold transition-all ${tagSize === TagSize.SMALL ? 'bg-white text-slate-900 shadow' : 'text-slate-400 hover:bg-slate-700'}`}>Compact</button>
                          <button onClick={() => setTagSize(TagSize.MEDIUM)} className={`px-3 py-1.5 rounded-lg text-xs font-semibold transition-all ${tagSize === TagSize.MEDIUM ? 'bg-white text-slate-900 shadow' : 'text-slate-400 hover:bg-slate-700'}`}>Standard</button>
                          <button onClick={() => setTagSize(TagSize.LARGE)} className={`px-3 py-1.5 rounded-lg text-xs font-semibold transition-all ${tagSize === TagSize.LARGE ? 'bg-white text-slate-900 shadow' : 'text-slate-400 hover:bg-slate-700'}`}>Large</button>
                      </div>

                      <div className="flex items-center gap-2 ml-2 pl-2 border-l border-slate-700">
                        {isExporting ? (
                          <div className="flex items-center gap-2 text-slate-400 px-3 py-2 bg-slate-800 rounded-lg">
                              <Loader2 className="animate-spin" size={18} />
                              <span className="text-xs font-medium">Processing...</span>
                          </div>
                        ) : (
                          <>
                              <button onClick={handleDownloadPDF} disabled={products.length === 0} className="p-2.5 rounded-xl bg-slate-800 text-slate-300 hover:bg-slate-700 hover:text-white transition-all disabled:opacity-30 disabled:cursor-not-allowed" title="Save as PDF"> <FileText size={18} /> </button>
                              <button onClick={handleDownloadDoc} disabled={products.length === 0} className="p-2.5 rounded-xl bg-slate-800 text-slate-300 hover:bg-slate-700 hover:text-white transition-all disabled:opacity-30 disabled:cursor-not-allowed" title="Save as Word Doc"> <File size={18} /> </button>
                              <button onClick={handleDownloadPNG} disabled={products.length === 0} className="p-2.5 rounded-xl bg-slate-800 text-slate-300 hover:bg-slate-700 hover:text-white transition-all disabled:opacity-30 disabled:cursor-not-allowed" title="Save as PNG Images"> <Image size={18} /> </button>
                          </>
                        )}
                        <button onClick={handlePrint} disabled={products.length === 0} className="flex items-center gap-2 bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-indigo-900/30 transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none ml-2"> <Printer size={18} strokeWidth={2.5} /> Print </button>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </header>
            <main className="max-w-[1400px] mx-auto p-6 space-y-8 print:p-0 print:space-y-0 print:w-full print:max-w-none">
              {activeTab === 'generator' && (
                <>
                  <section className="no-print animate-in fade-in slide-in-from-bottom-4 duration-500"> <InputForm onAddProduct={handleAddProduct} onBulkAdd={handleBulkAdd} onClear={handleClear} hasItems={products.length > 0} /> </section>
                  <section className="print:w-full">
                    {products.length === 0 ? ( <div className="flex flex-col items-center justify-center py-24 bg-white rounded-3xl border-2 border-dashed border-slate-200 no-print text-center shadow-sm"> <div className="bg-slate-50 p-6 rounded-full mb-4"> <PackageOpen className="w-12 h-12 text-slate-300" strokeWidth={1.5} /> </div> <h3 className="text-xl font-bold text-slate-700 mb-2">Your shelf is empty</h3> <p className="text-slate-400 max-w-sm">Add individual items using the form above or upload a CSV file to generate your tags instantly.</p> </div> ) : (
                      <div className="overflow-auto print:overflow-visible pb-12">
                        <div className="flex justify-between items-center mb-6 no-print"> <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"> <Sparkles className="text-indigo-500 w-5 h-5" /> Print Preview <span className="text-lg font-normal text-slate-400 ml-2"> ({products.length} Items &bull; {paginatedResult.pages.length} Sheets) </span> </h2> <div className="flex gap-2 items-center"> <span className="text-xs font-medium text-amber-700 bg-amber-50 px-3 py-1.5 rounded-full border border-amber-100 flex items-center"> <span className="w-1.5 h-1.5 bg-amber-500 rounded-full mr-2"></span> Tip: Hover over sheet edges to adjust margins </span> </div> </div>
                        {paginatedResult.pages.map((pageProducts, pageIndex) => {
                          const orientation = paginatedResult.orientations[pageIndex]; const isLandscape = orientation === 'landscape';
                          const paddingX = config.sheetSettings?.paddingX ?? DEFAULT_CONFIG.sheetSettings.paddingX; const paddingY = config.sheetSettings?.paddingY ?? DEFAULT_CONFIG.sheetSettings.paddingY; const gapX = config.sheetSettings?.gapX ?? DEFAULT_CONFIG.sheetSettings.gapX; const gapY = config.sheetSettings?.gapY ?? DEFAULT_CONFIG.sheetSettings.gapY;
                          const widthCM = isLandscape ? 29.7 : 21.0; const heightCM = isLandscape ? 21.0 : 29.7;
                          return (
                            <div key={pageIndex} className={`print-page print-page-${orientation} bg-white shadow-2xl shadow-slate-200/50 mb-12 mx-auto relative group/sheet print:shadow-none print:m-0 print:mb-0 print:break-after-page rounded-sm overflow-hidden`} style={{ width: `${widthCM}cm`, height: `${heightCM}cm`, minHeight: `${heightCM}cm`, transition: 'width 0.3s, height 0.3s', }}>
                                <div className="absolute top-0 left-0 w-full opacity-0 group-hover/sheet:opacity-100 transition-opacity z-20"> <Ruler length={widthCM} orientation="horizontal" padding={paddingX} onPaddingChange={(val) => handleSheetPaddingChange('x', val)} /> </div>
                                <div className="absolute top-0 left-0 h-full opacity-0 group-hover/sheet:opacity-100 transition-opacity z-20"> <Ruler length={heightCM} orientation="vertical" padding={paddingY} onPaddingChange={(val) => handleSheetPaddingChange('y', val)} /> </div>
                                <div className="absolute top-3 right-3 flex gap-2 no-print z-50 opacity-0 group-hover/sheet:opacity-100 transition-all duration-300"> <div className="bg-slate-800 text-slate-200 px-3 py-1.5 rounded-full text-xs font-mono shadow-lg backdrop-blur-sm"> Page {pageIndex + 1} </div> <button onClick={() => handlePageOrientationToggle(pageIndex, orientation)} className="bg-white hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 px-3 py-1.5 rounded-full shadow-lg text-xs flex items-center gap-1.5 transition-all font-medium border border-slate-100"> <RefreshCw size={12} /> {isLandscape ? 'Landscape' : 'Portrait'} </button> </div>
                                <div className="w-full h-full flex flex-wrap content-start justify-center relative z-10" style={{ padding: `${paddingY}cm ${paddingX}cm`, rowGap: `${gapY}cm`, columnGap: `${gapX}cm` }}>
                                  {pageProducts.map((product) => ( <div key={product.id} className="relative group print:inline-block print:m-0 box-border cursor-grab active:cursor-grabbing" draggable={true} onDragStart={(e) => onProductDragStart(e, product.id)} onDragEnd={onProductDragEnd} onDragOver={onProductDragOver} onDrop={(e) => onProductDrop(e, product.id)}> <div className="p-0"> <PriceTag product={product} size={tagSize} fontTheme={fontTheme} config={config} onVisualChange={(updates) => handleProductVisualChange(product.id, updates)} onProductChange={handleProductChange} onLabelChange={handleLabelChange} /> <button onClick={() => handleRemoveProduct(product.id)} className="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white w-6 h-6 rounded-full shadow-md opacity-0 group-hover:opacity-100 transition-all scale-90 group-hover:scale-100 no-print z-30 flex items-center justify-center text-lg leading-none" title="Remove Tag"> &times; </button> </div> </div> ))}
                                </div>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </section>
                </>
              )}
              {activeTab === 'config' && (
                <div className="no-print animate-in fade-in zoom-in-95 duration-300">
                  <ConfigPanel config={config} onUpdate={handleConfigUpdate} onSave={handleSaveConfig} onReset={handleResetConfig} onUndo={handleUndo} onRedo={handleRedo} canUndo={canUndo} canRedo={canRedo} />
                  <div className="mt-12 max-w-4xl mx-auto"> <div className="text-center mb-8"> <h3 className="text-xl font-bold text-slate-800">Live Interactive Preview</h3> <p className="text-sm text-slate-500 mt-1">Drag and drop sections inside the tag below to reorder them.</p> </div> <div className="flex justify-center bg-slate-200/50 p-12 rounded-3xl border border-slate-200 shadow-inner"> <div className="w-auto shadow-2xl shadow-slate-300/50 rounded transform hover:scale-[1.02] transition-transform duration-300"> <PriceTag product={{ id: 'preview', name: 'Example Product', quantity: '1 Kg', mrp: 100, price: 60 }} size={TagSize.MEDIUM} fontTheme={fontTheme} config={config} enableDnD={true} onOrderChange={handleSectionReorder} onVisualChange={(updates) => updateState(prev => ({ ...prev, config: { ...prev.config, visuals: { ...prev.config.visuals, ...updates } } }))} /> </div> </div> </div>
                </div>
              )}
            </main>
            <footer className="max-w-7xl mx-auto p-8 text-center text-slate-400 text-sm no-print"> <p>&copy; {new Date().getFullYear()} Smart Retail Solutions. Optimized for Chrome Desktop Printing.</p> </footer>
            {showSaveToast && ( <div className="fixed bottom-8 right-8 bg-slate-800 text-white px-6 py-3.5 rounded-xl shadow-2xl animate-bounce z-50 flex items-center border border-slate-700"> <div className="mr-3 bg-green-500 rounded-full p-1"> <svg className="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M5 13l4 4L19 7"></path></svg> </div> <span className="font-medium">Configuration Saved Successfully</span> </div> )}
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>